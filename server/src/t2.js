const express = require('express') //å¯¼å…¥ Express æ¨¡å—
const bodyParser = require('body-parser') //å¯¼å…¥ body-parser æ¨¡å—ç”¨äºè§£æè¯·æ±‚ä½“ï¼Œ
const http = require('http') //å¯¼å…¥ HTTP æ¨¡å—
const cors = require('cors') //å¯¼å…¥ CORS æ¨¡å—
const app = express() //åˆ›å»ºä¸€ä¸ª Express åº”ç”¨ç¨‹åºå®ä¾‹
const server = http.createServer(app)
const mysql = require('mysql');

const utils = require('./lib/utils')
const openai = require('./services/openai')

//è¯»å–.envæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨process.env.SERVER_PORTï¼Œå°±å¯ä»¥ä½¿ç”¨äº†
require('dotenv').config()

// ä¿å­˜æ¯ä¸ªå¯¹è¯çš„çŠ¶æ€, name2pictureåç§°å¯¹åº”çš„å›¾ç‰‡,å¼‚æ­¥æŸ¥è¯¢ï¼Œæ¯”è¾ƒæ…¢
let users = {};

app.use((err, req, res, next) => {
    // é”™è¯¯å¤„ç†é€»è¾‘
    console.error(`æœåŠ¡å™¨å‡ºç°é”™è¯¯ï¼Œè¯·æ±‚çš„æ¥å£æ˜¯: ${req.url}, å‡ºç°çš„é”™è¯¯æ˜¯: ${err}`);
    res.status(500).send('Internal Server Error');
});

app.use(cors())
//è®¾ç½®é™æ€ç›®å½•
app.use(express.static('public'));
//app.use(bodyParser.json())
//ä½¿ç”¨ body-parser æ¨¡å—çš„ json() å‡½æ•°æ¥è§£æ JSON æ•°æ®ã€‚è¿™é‡Œçš„é…ç½®é€‰é¡¹ {limit: '50mb'} è¡¨ç¤ºå…è®¸è¯·æ±‚æ•°æ®çš„æœ€å¤§ä½“ç§¯ä¸º 50MBã€‚
app.use(bodyParser.json({ limit: '50mb' }))
app.use(bodyParser.urlencoded({ limit: '50mb', extended: true })) //ä½¿ç”¨ body-parser æ¨¡å—çš„ urlencoded() å‡½æ•°æ¥è§£æè¡¨å•æ•°æ®ã€‚è¿™é‡Œçš„é…ç½®é€‰é¡¹ {limit: '50mb', extended: true} è¡¨ç¤ºå…è®¸è¯·æ±‚æ•°æ®çš„æœ€å¤§ä½“ç§¯ä¸º 50MBï¼Œå¹¶ä¸”å…è®¸è§£æåµŒå¥—çš„è¡¨å•æ•°æ®ã€‚


// æ¨¡æ‹Ÿæ•°æ®
const anwserObj = {
    "hello": "Hello there! Ready to dive into the enchanting world of fragrances? What can I assist you with today in the realm of scents? ğŸ˜ŠğŸŒ¸",
    "ä½ å¥½": "ä½ å¥½ï¼åœ¨è¿™é¦™æ°›çš„ä¸–ç•Œé‡Œï¼Œæˆ‘å°±æ˜¯ä½ çš„å‘å¯¼ï¼ŒBeautyChat2.0ï¼éšæ—¶å‡†å¤‡ä¸ºä½ æ­å¼€å„ç§é¦™æ°´çš„ç¥ç§˜é¢çº±ã€‚ä½ ä»Šå¤©æƒ³çŸ¥é“ç‚¹ä»€ä¹ˆå‘¢ï¼Ÿæœ‰å…³é¦™æ°›çš„ä»»ä½•é—®é¢˜ï¼Œå°½ç®¡å‘æˆ‘æé—®å§ï¼ğŸŒ¸ğŸ‘ƒâœ¨",
    "æœ¨è´¨ä¸œæ–¹è°ƒé¦™æ°´æ¨è": "å¥½çš„ï¼ŒJohnsonï¼Œæœ‰ä¸€æ¬¾å«åšâ€œè§‚å¤æ˜†ä»‘ç…®é›ªâ€çš„é¦™æ°´ï¼Œå®ƒçš„é¦™è°ƒæ˜¯æœ¨è´¨ä¸œæ–¹è°ƒï¼Œä½†æ˜¯å‰è°ƒä¸­å¸¦æœ‰é¦™æŸ æª¬çš„å‘³é“ï¼Œåº”è¯¥å¯ä»¥æ»¡è¶³ä½ å¯¹æ©˜å­é¦™å‘³çš„æœŸå¾…ã€‚å®ƒçš„é¦™å‘³æè¿°ä¸­ä¹Ÿæœ‰æåˆ°â€œæŸ‘æ©˜â€ï¼Œç»™äººæ·±æ²‰ã€æ¸…å‡‰ã€ç”œç”œçš„æ„Ÿè§‰ï¼Œéå¸¸é€‚åˆå¤æ—¥ä½¿ç”¨ã€‚ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªé“¾æ¥ã€13â€ æŸ¥çœ‹è¯¦æƒ…ã€‘æ¥è·å–æ›´å¤šä¿¡æ¯ã€‚å¸Œæœ›è¿™æ¬¾é¦™æ°´èƒ½è®©ä½ çš„å¤å¤©æ›´åŠ æ¸…æ–°æ€¡äººï¼",
    "ä½ çŸ¥é“å“ªæ¬¾é¦™æ°´çš„å‘³é“æ˜¯æ©˜å­å‘³å—ï¼Ÿ": "å“¦ï¼Œæœ‰æ¬¾é¦™æ°´å°±æ˜¯æŸ‘æ©˜æ§ä½ çš„èœï¼å°è¯•ä¸€ä¸‹â€œè§‚å¤æ˜†ä»‘ç…®é›ªâ€ï¼Œå®ƒæ˜¯ä¸€æ¬¾ä¸­æ€§é¦™ï¼Œè§„æ ¼30mlï¼Œä»·æ ¼498.0å…ƒï¼Œå¸¦æœ‰æœ¨è´¨ã€èŠ³é¦™æ¤ç‰©ã€æ¸…æ–°è¾›è¾£ä»¥åŠä½ å–œæ¬¢çš„æŸ‘æ©˜å‘³ã€‚è¿™æ¬¾é¦™æ°´çš„å‰è°ƒåŒ…å«äº†é¦™æŸ æª¬ï¼Œæœæ¾å­å’Œä¸æŸï¼Œç»å¯¹èƒ½è®©ä½ æ„Ÿå—åˆ°æ¸…æ–°å®œäººçš„æ©˜å­é¦™æ°”ã€‚ä½¿ç”¨æ—¶ï¼Œä½ å¯èƒ½ä¼šæƒ³è±¡ç€ä¸œæ–¹æ–‡åŒ–çš„å±±æ²³åŸé‡ï¼Œæ„Ÿå—åˆ°æ€€æ—§å’Œæ¸©æš–çš„æƒ…ç»ªã€‚å®ƒé€‚ç”¨äºå„ç§åœºåˆï¼Œå°¤å…¶æ˜¯åœ¨å®¶å±…é¦™è–°åˆ†äº«æˆ–æ˜¯ä¼ ç»Ÿæ–‡åŒ–æ´»åŠ¨ä¸­ã€‚ç«‹åˆ»å°±èƒ½æ‹¥æŠ±å®ƒäº†ï¼Œé€šè¿‡è¿™ä¸ªé“¾æ¥å»æŠŠå®ƒå¸¦å›å®¶å§: [ç‚¹æˆ‘è´­ä¹°](https://detail.tmall.com/item.htm?abbucket=11&id=676539654541&rn=760fb2aa967606ede8027516fab139b9&skuId=4859629692517&spm=a1z10.3-b-s.w4011-24426768373.74.5a6435d7t1Pawn)ã€11â€ sourceã€‘ã€‚å—¯å“¼ï½å¸¦ä¸Šè¿™æ¬¾é¦™æ°´ï¼Œä½ ä¹Ÿèƒ½é—»ç€æ©˜å­å‘³å„¿ï¼Œæ„Ÿè§‰åƒæ˜¯è·Ÿä¸€ä½å¥½å‹æŠ±æŠ±å‘¢ï¼",
    "æ©˜å­å‘³é¦™æ°´æ¨è": " å™¢ï¼Œæ©˜å­çš„é¦™å‘³ï¼Œé‚£çœŸæ˜¯æ™´æœ—åˆå¯å£å“¦ï¼æœ‰æ¬¾é¦™æ°´å«åšâ€œè§‚å¤æ˜†ä»‘ç…®é›ªâ€ï¼Œå®ƒå…·æœ‰ä¸€ä¸ä¸çš„æŸ‘æ©˜é¦™å‘³ï¼Œåœ¨å…¶ä»–æœ¨è´¨å’ŒèŠ³é¦™æ¤ç‰©è°ƒæ€§çš„æ˜ è¡¬ä¸‹ï¼Œç»™ä½ çš„å—…è§‰å¸¦æ¥ä¸€ç§æ¸…æ–°è¾›è¾£çš„ä½“éªŒã€‚æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šå¾®é£ä¸­å¸¦æ¥å‡‰çˆ½çš„æ©˜é¦™ï¼Œå°±åƒä¸€ä¸ªç‚ç‚å¤æ—¥çš„é¿é£æ¸¯ã€‚ä½¿ç”¨è¿™æ¬¾é¦™æ°´ï¼Œæ— ç–‘ä¼šå¸¦æ¥ä¸€è‚¡æ¸…æ–°æ½‡æ´’çš„æ°”æ°›ã€13â€ sourceã€‘ã€‚\nå¦‚æœä½ æƒ³äº†è§£æ›´å¤šæˆ–è€…è´­ä¹°è¿™æ¬¾äº§å“ï¼Œå¯ä»¥ç‚¹å‡»è¿™ä¸ªé“¾æ¥è¿›è¡Œæ¢å¯»ï¼š[è§‚å¤æ˜†ä»‘ç…®é›ªé¦™æ°´](https://detail.tmall.com/item.htm?abbucket=11&id=676539654541&rn=760fb2aa967606ede8027516fab139b9&skuId=4859629692517&spm=a1z10.3-b-s.w4011-24426768373.74.5a6435d7t1Pawn)ã€‚å¼€å¯æ©˜å­é¦™æ°›ä¹‹æ—…ï¼Œä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ ğŸŠâœ¨",
    "ä»‹ç»ä¸‰æ¬¾è¿·äººçš„é¦™æ°´": "äº²çˆ±çš„é¦™æ°´çˆ±å¥½è€…ï¼Œè®©æˆ‘ä¸ºæ‚¨ä»‹ç»ä¸‰æ¬¾è¿·äººçš„é¦™æ°´ï¼š1. é—»çŒ®æŸ”éŸ§è†æ£˜ - è¿™æ¬¾é¦™æ°´å……æ»¡äº†é’è‰å’ŒèŠ«è½çš„æ¸…æ–°å‰è°ƒï¼Œä¸­è°ƒåˆ™æ˜¯ç«ç‘°ä¸ç‰¡ä¸¹çš„æµ“éƒèŠ±é¦™ï¼Œè€Œåè°ƒåˆ™ç”±å­œç„¶ã€é¦™æ ¹è‰åŠå®‰æ¯é¦™æ„æˆï¼Œç»™äººä¸€ç§æ–°é²œã€æ¸©æš–ã€ç¥ç§˜åˆè¿·äººçš„ä½“éªŒã€‚é€‚åˆåœ¨å®¶ä¸­è‡ªç„¶æ¸…æ–°çš„ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå…¶ç‰¹è‰²åœ¨äºæ··åˆäº†è¾›è¾£ä¸æ¸©æŸ”ï¼Œå°±åƒæ˜¯åœ¨èŠ±åœƒä¸­æƒ³è¦é‡‡æ‘˜åˆç»½ç«ç‘°çš„æ„Ÿè§‰ã€9â€ é“¾æ¥ã€‘ã€‚ä¸ºä¿æŒç¥ç§˜æ„Ÿï¼Œæˆ‘ä¼šæ…¢æ…¢æ­æ™“å…¶ä½™ä¸¤æ¬¾æ¨èçš„é¦™æ°´ï¼Œæ•¬è¯·æœŸå¾…æˆ‘çš„ä¸‹ä¸€ä¸ªå›å¤å“¦ï¼âœ¨ğŸ¥³å¼€å§‹æŸ¥è¯¢æ¶ˆæ¯ä¸­çš„å•†å“å¯¹åº”çš„å›¾ç‰‡: äº²çˆ±çš„é¦™æ°´çˆ±å¥½è€…ï¼Œè®©æˆ‘ä¸ºæ‚¨ä»‹ç»ä¸‰æ¬¾è¿·äººçš„é¦™æ°´ï¼š1. é—»çŒ®æŸ”éŸ§è†æ£˜ - è¿™æ¬¾é¦™æ°´å……æ»¡äº†é’è‰å’ŒèŠ«è½çš„æ¸…æ–°å‰è°ƒï¼Œä¸­è°ƒåˆ™æ˜¯ç«ç‘°ä¸ç‰¡ä¸¹çš„æµ“éƒèŠ±é¦™ï¼Œè€Œåè°ƒåˆ™ç”±å­œç„¶ã€é¦™æ ¹è‰åŠå®‰æ¯é¦™æ„æˆï¼Œç»™äººä¸€ç§æ–°é²œã€æ¸©æš–ã€ç¥ç§˜åˆè¿·äººçš„ä½“éªŒã€‚é€‚åˆåœ¨å®¶ä¸­è‡ªç„¶æ¸…æ–°çš„ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå…¶ç‰¹è‰²åœ¨äºæ··åˆäº†è¾›è¾£ä¸æ¸©æŸ”ï¼Œå°±åƒæ˜¯åœ¨èŠ±åœƒä¸­æƒ³è¦é‡‡æ‘˜åˆç»½ç«ç‘°çš„æ„Ÿè§‰ã€9â€ é“¾æ¥ã€‘ã€‚ä¸ºä¿æŒç¥ç§˜æ„Ÿï¼Œæˆ‘ä¼šæ…¢æ…¢æ­æ™“å…¶ä½™ä¸¤æ¬¾æ¨èçš„é¦™æ°´ï¼Œæ•¬è¯·æœŸå¾…æˆ‘çš„ä¸‹ä¸€ä¸ªå›å¤å“¦ï¼âœ¨ğŸ¥³",
    "è¯·é—®ä»€ä¹ˆé¦™æ°´é—»èµ·æ¥æ˜¯å†·çš„å‘€ï¼Ÿä»¥åŠä»€ä¹ˆé¦™æä¼šæœ‰å†·æ„Ÿï¼Ÿ":"å†·è‹¥å†°éœœï¼Œé¦™è‹¥å¯’é£ï¼æ¨èç»™ä½ çš„æ˜¯ã€å‡¯åˆ©å®‰å¯’å†°ä¼ç‰¹åŠ ã€‘ï¼ˆKilian Vodka on the Rocksï¼‰ï¼Œè¿™æ¬¾é¦™æ°´è±¡å¾ç€çº¯ç²¹æ— æš‡çš„å†·æ„Ÿã€‚é—»èµ·æ¥ï¼Œå®ƒå°±åƒæ˜¯ä¸€æ¯å…‰æ»‘å†°å‡‰çš„ä¼ç‰¹åŠ ï¼Œæ¿€å‘å‡ºæ¸…å†·çš„é¦™æ°›ä½“éªŒã€‚è‡³äºä½ æåˆ°çš„å†·æ„Ÿé¦™æï¼Œæ¯”å¦‚è–„è·æˆ–è€…æ¡‰æ ‘ç­‰é€šå¸¸ä¼šç»™é¦™æ°´å¸¦æ¥ä¸€ç§å‡‰çˆ½ä¹‹æ„Ÿã€‚è·Ÿå†·æ„Ÿé¦™æ°´ä¸€æ ·ï¼Œè¿™äº›é¦™æä¹Ÿèƒ½è®©ä½ æ„Ÿåˆ°ä¸€è‚¡æ¸…å‡‰ä¹‹æ„ï¼Œå®›å¦‚ä¸€ç¼•å¯’é£æ è¿‡ç‚ç‚çƒˆæ—¥ï¼Œç»™äººå¸¦æ¥ä¸€æŠ¹å¿ƒçµçš„æ…°è—‰ã€‚å¦‚æœä½ å–œæ¬¢è¿™ç§å†°å‡‰çš„é¦™æ°”ï¼Œé‚£ä¹ˆä¸å¦¨å°è¯•ä¸€ä¸‹è¿™æ¬¾é¦™æ°´å§ï¼Œé“¾æ¥æˆ³è¿™é‡Œï¼š[ç‚¹å‡»å‰å¾€](https://detail.tmall.com/item.htm?abbucket=11&id=676539654541&rn=1d22b851a2e3ec27feca3b2891ff3b17&skuId=47394615272&spm=a1z10.3-b-s.w4011-24426768373.74.5a6435d7t1Pawn)ã€‚",
    "æœ‰æ²¡æœ‰ç‹¼ç‹—å‘³çš„é¦™æ°´å‘€": "å“‡å—·ï¼å¦‚æœä½ æ­£å¯»æ‰¾å¸¦æœ‰ç‹¼ç‹—èˆ¬é‡æ€§ä¸è‡ªç„¶æ°”æ¯çš„é¦™æ°´ï¼Œé‚£ä¹ˆä½ å¯èƒ½ä¼šå¯¹ã€è§‚å¤æ˜†ä»‘ç…®é›ªã€‘é¦™æ°´æ„Ÿå…´è¶£ã€‚è¿™æ¬¾é¦™æ°´æ•£å‘ç€æ·±æ²‰è€Œæ¸…å‡‰çš„æœ¨è´¨é¦™è°ƒï¼Œè®©äººæƒ³èµ·äºšå¯’å¸¦é’ˆå¶æ—ä¸­çš„æ¾è„‚æ°”æ¯ï¼Œä»¿ä½›ç½®èº«äºæ˜†ä»‘å±±è„‰çš„é›„ä¼Ÿæ™¯è‡´ä¸­ã€‚å®ƒçš„é¦™æ°”èƒ½å¤Ÿå”¤èµ·å®é™å’Œæ€€æ—§çš„æƒ…ç»ªï¼Œè¿˜æœ‰ç€ç‹¬ç‰¹çš„ä¸œæ–¹æ–‡åŒ–æ„å¢ƒã€‚ä¸è®ºæ˜¯åœ¨å®¶å±…é¦™è–°åˆ†äº«æ—¶ï¼Œè¿˜æ˜¯åœ¨å¤å¤œçš„ä¼ ç»Ÿæ–‡åŒ–æ´»åŠ¨ä¸­ï¼Œéƒ½èƒ½æ˜¾ç°å‡ºä½ çš„ä¸ªæ€§ä¸æ·±æ²‰çš„åŒ—æ–¹æ°”è´¨ã€‚ç°åœ¨å°±å»æ‹¥æŠ±è¿™ä»½é‡æ€§å§ï¼å»çœ‹çœ‹åº—é“ºé“¾æ¥ï¼Œæ„Ÿå—ä¸€ä¸‹ï¼š[ç‚¹å‡»è¿™é‡Œ](https://detail.tmall.com/item.htm?abbucket=11&id=676539654541&rn=760fb2aa967606ede8027516fab139b9&skuId=4859629692517&spm=a1z10.3-b-s.w4011-24426768373.74.5a6435d7t1Pawn)ã€‚",
    "æœ‰æ²¡æœ‰æ¡‚èŠ±å‘³çš„é¦™æ°´": "å¥½æ¶ˆæ¯ï¼Œè¿ªå¥¥å°å§é¦™æ°´çš„é¦™è°ƒå±äºèŠ±é¦™è¥¿æ™®è°ƒï¼Œä¸­è°ƒæ°å¥½å«æœ‰æ©™èŠ±æ²¹ï¼Œè¿™ç§é¦™æ–™é€šå¸¸èƒ½å¸¦å‡ºç±»ä¼¼æ¡‚èŠ±çš„é¦™æ°”ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šæ„Ÿå—åˆ°ä»è¡€æ©™çš„æ–°é²œæœé¦™å¼€å§‹ï¼Œé€æ¸è¿‡æ¸¡åˆ°ç«ç‘°å’Œæ©™èŠ±æ²¹çš„èŠ±é¦™è°ƒï¼Œå¹¶æœ€ç»ˆæ²‰æ·€åœ¨å¹¿è—¿é¦™çš„æ¸©æš–æœ¨è´¨é¦™ä¸­ã€‚è¿™æ¬¾é¦™æ°´ä»¥å…¶ç‹¬ç‰¹è€Œç²¾è‡´çš„é¦™æ°”ï¼Œé€‚åˆå¸Œæœ›æ•£å‘æ¸…æ–°åŠä½è°ƒå¥¢åæ„Ÿçš„å¥³æ€§ã€‚å¦‚æœä½ å¯¹è¿™æ¬¾é¦™æ°´æ„Ÿå…´è¶£ï¼Œä½ å¯ä»¥é€šè¿‡è¿ªå¥¥çš„å®˜æ–¹æ——èˆ°åº—è´­ä¹°ï¼š[ç‚¹å‡»è¿™é‡Œ](https://detail.tmall.com/item.htm?abbucket=3&id=618227629963&ns=1&spm=a21n57.1.0.0.588c523cz0nslf&skuId=4728579503048)ã€‚å¸Œæœ›ä½ èƒ½å–œæ¬¢è¿™æ¬¾æ•£å‘ç€æ¡‚èŠ±é¦™çš„è¿ªå¥¥å°å§é¦™æ°´ï¼",
    "é—»èµ·æ¥éªšéªšçš„é¦™æ°´": "çœ‹æ¥æˆ‘åœ¨æœç´¢çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€ç‚¹å„¿å°æ›²æŠ˜ï¼Œä½†åˆ«æ‹…å¿ƒï¼Œå°±åœ¨åˆšæ‰æˆ‘å‘ç°äº†ä¸€æ¬¾å¯èƒ½ç¬¦åˆä½ å½¢å®¹çš„éªšéªšé¦™æ°´çš„å•†å“ã€‚å®ƒçš„åå­—å«åšâ€œè¿ªå¥¥å°å§â€ï¼Œå¸¦æœ‰è¡€æ©™ã€ç«ç‘°å’Œæ©™èŠ±æ²¹çš„å‰ä¸­è°ƒï¼Œä»¥åŠå¹¿è—¿é¦™çš„åè°ƒï¼Œæ•´ä½“é¦™å‘³æ˜¯ä¸€ç§ç”œç¾æµ“éƒçš„èŠ±é¦™è¥¿æ™®è°ƒã€‚è¿™æ¬¾é¦™æ°´ä¼¼ä¹é€éœ²å‡ºä¸€ç§æ–°é²œã€æ€§æ„Ÿç”œèœœã€è¿˜æœ‰ä¸€ç‚¹â€œé…·ä¸â€ï¼ˆå¯èƒ½å¯ä»¥ç†è§£ä¸ºä¸€ç‚¹éªšæ°”ï¼Ÿï¼‰çš„æ„Ÿè§‰å“¦ï¼å¯¹äºè¿™æ¬¾é¦™æ°´çš„æ›´è¯¦ç»†èµ„è®¯ï¼Œæˆ‘åœ¨æŸ¥æ‰¾æ—¶å‡ºç°äº†ä¸€äº›å°å°çš„æŠ€æœ¯é—®é¢˜ï¼Œæ²¡èƒ½åŠæ—¶è·å–é“¾æ¥æ¥ä¸ºä½ æä¾›ã€‚ä¸è¿‡ï¼Œæ—¢ç„¶è¿™æ˜¯ä½ æ„Ÿå…´è¶£çš„é¦™æ°´ç±»å‹ï¼Œä½ å¯ä»¥å°è¯•åœ¨å„å¤§è´­ç‰©å¹³å°æœç´¢â€œè¿ªå¥¥å°å§â€ï¼Œç›¸ä¿¡ä½ å¾ˆå¿«å°±èƒ½æ‰¾åˆ°ç›¸å…³çš„è´­ä¹°é“¾æ¥å•¦ã€‚è®°å¾—ï¼Œè¦é€‰æ‹©ä¿¡èª‰å¥½çš„åº—é“ºå“¦~ âœ¨ğŸ›ï¸âœ¨",
}

app.post('/simulate_json', (req, res) => {
    console.log(new Date().toLocaleTimeString(), 'æ”¶åˆ°äº†Streamè¯·æ±‚')
    const { user_id, content } = req.body
    console.log(new Date().toLocaleTimeString(), `ç”¨æˆ·id: ${user_id}, é—®é¢˜æ˜¯: ${content}`)
    let created_at = Date.now()
    let id = utils.getSimpleId()
    let role = "user"
    let name = "ç”¨æˆ·"

    if (!user_id || !name || !content || !role || !id || !created_at) {
        res.status(400).send('è¯·æ±‚æ•°æ®é”™è¯¯ï¼Œéƒ¨åˆ†å­—æ®µä¸ºç©ºçš„ï¼Œè¯·æ£€æŸ¥');
        return
    }

    const output_data = anwserObj[content]
    output_data = "hello"
    const intention = getIntention_simulate(content)
    const more_question = guess_quesion_simulate(content)

    try {


        let flagFinish = false

        let MAX_COUNT = 2 * 600 // 120s 
        let TIME_DELAY = 100 // 100ms
        let count = 0

        do {
            //ä¸æ–­è·å–æœ€æ–°çš„çŠ¶æ€
            const status = 'completed'

            console.log(`Status: ${status} ${(new Date()).toLocaleTimeString()}`)

            if (status === 'completed') {
                console.log(`ç”Ÿæˆçš„ç»“æœæ˜¯: ${output_data}`)
                let output_content = output_data.replace(/\ã€\d+â€ source\ã€‘/g, "");
                output_content = output_content.replace(/\ã€\d+â€ æŸ¥çœ‹è¯¦æƒ…\ã€‘/g, "");
                output_content = output_content.replace(/\ã€\d+â€ é“¾æ¥\ã€‘/g, "");
                if (intention === 'recommend') {
                    let three_info = findMsgImage(output_content)
                    const data = {
                        code: '0000',
                        msg: 'æˆåŠŸ',
                        data: {
                            content: output_content,
                            picture: three_info,
                            more_question: more_question,
                        },
                    }
                    res.json(data); // è¿”å› JSON
                    return
                } else {
                    const data = {
                        code: '0000',
                        msg: 'æˆåŠŸ',
                        data: {
                            content: output_content,
                            picture: [],
                            more_question: [],
                        },
                    }
                    res.json(data); // è¿”å› JSON
                    return
                }
                flagFinish = true

            } else if (status === 'requires_action') {

                console.log('run-data', run_data)

                const required_action = run_data.required_action
                const required_tools = required_action.submit_tool_outputs.tool_calls

                console.log('required-action', required_action)
                console.log('required-tools', required_tools)

                const tool_output_items = []

                required_tools.forEach((rtool) => {

                    let tool_output = { status: 'error', message: 'No function found' }

                    tool_output_items.push({
                        tool_call_id: rtool.id,
                        output: JSON.stringify(tool_output)
                    })

                })

                console.log('tools-output', tool_output_items)


                console.log('ret-tool', ret_tool)

            } else if (status === 'expired' || status === 'cancelled' || status === 'failed') {

                flagFinish = true

            }

            if (!flagFinish) {

                count++

                if (count >= MAX_COUNT) {

                    flagFinish = true

                }

            }

        } while (!flagFinish)

        res.end()

    } catch (error) {

        console.log(error.name, error.message)

        res.sendStatus(400)
        return

    }

})


//å¯åŠ¨äº† HTTP æœåŠ¡å™¨ï¼Œå¼€å§‹ç›‘å¬æŒ‡å®šçš„ç«¯å£ï¼Œå½“æœ‰è¯·æ±‚åˆ°è¾¾æ—¶ä¼šè°ƒç”¨å›è°ƒå‡½æ•°
server.listen(process.env.SERVER_PORT, () => {
    console.log(`å¯åŠ¨æœåŠ¡ç«¯...`, (new Date()).toLocaleTimeString())
    console.log(`ç›‘å¬ç«¯å£ï¼š ${process.env.SERVER_HOST}:${process.env.SERVER_PORT}`)

})
//ä¸€ä¸ªå¤„ç†è¿›ç¨‹æ¥æ”¶åˆ° SIGINT ä¿¡å·ï¼ˆé€šå¸¸æ˜¯é€šè¿‡æŒ‰ä¸‹ Ctrl + C è§¦å‘ï¼‰æ—¶çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œå®ƒåœ¨æ¥æ”¶åˆ°è¯¥ä¿¡å·æ—¶æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚
process.on('SIGINT', async () => {
    console.log(new Date().toLocaleTimeString(), 'Server process terminatedè§¦å‘ï¼šSIGINT')
    console.log("\nTest Server process terminated.");
    // éå†usersä¸­çš„æ¯ä¸ªçº¿ç¨‹idï¼Œç„¶ååˆ é™¤
    for (let user_id in users) {
        disconnect(user_id)
    }

    process.exit();
})

process.on('SIGTERM', async () => {
    console.log(new Date().toLocaleTimeString(), 'Server process terminatedè§¦å‘ï¼šSIGTERM')
    console.log("\nTest Server process terminated.");
    // éå†usersä¸­çš„æ¯ä¸ªçº¿ç¨‹idï¼Œç„¶ååˆ é™¤
    for (let user_id in users) {
        disconnect(user_id)
    }
    process.exit();
})